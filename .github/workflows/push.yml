name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run bats unit tests
        run: |
            docker-compose run --rm github bats
      - name: Test deploying to AWS Lambda
        env:
          input_app_dir: ./test-project
          input_project_name: zappa-test
          input_aws_default_region: eu-central-1
          input_aws_access_key_id: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          input_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          input_stage: dev
        run: |
          docker-compose run --rm zappa deploy
          echo "This output was generated by the step (API_GATEWAY_URL): ${API_GATEWAY_URL}"
          echo "This output was generated by the step (DOMAIN_URL): ${DOMAIN_URL}"
          echo "This output was generated by the step (LAMBDA_NAME): ${LAMBDA_NAME}"
          MATCH="^https://[a-z0-9]\{10,10\}\.execute-api\.${AWS_DEFAULT_REGION}\.amazonaws\.com/${STAGE}$"
          echo "${API_GATEWAY_URL}" | grep -q ${MATCH} # If matches --> Exit code 0 (=good)
      - name: undeploying from AWS Lambda
        env:
          input_app_dir: ./test-project
          input_project_name: zappa-test
          input_aws_default_region: eu-central-1
          input_aws_access_key_id: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          input_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          input_stage: dev
        run: |
          docker-compose run --rm zappa deploy
          echo "This output was generated by the step (API_GATEWAY_URL): ${API_GATEWAY_URL}"
          echo "This output was generated by the step (DOMAIN_URL): ${DOMAIN_URL}"
          echo "This output was generated by the step (LAMBDA_NAME): ${LAMBDA_NAME}"
          MATCH="^https://[a-z0-9]\{10,10\}\.execute-api\.${AWS_DEFAULT_REGION}\.amazonaws\.com/${STAGE}$"
          echo "${API_GATEWAY_URL}" | grep -q ${MATCH} # If matches --> Exit code 0 (=good)

          # TODO: Check if there is a smarter way to pass input variables to the undeployment of the test deployment
          export input_app_dir=${APP_DIR}
          export input_project_name=${PROJECT_NAME}
          export input_aws_default_region=${AWS_DEFAULT_REGION}
          export input_aws_access_key_id=${AWS_ACCESS_KEY_ID}
          export input_aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}
          export input_stage=${STAGE}
          docker-compose run --rm zappa undeploy
